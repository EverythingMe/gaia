Evme.DEFAULT_ICONS = {
  CONTACT: {
    "MIMEType": "image/png",
    "data": "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"
  }
};

Evme.IconManager = new function Evme_IconManager() {
  var NAME = "IconManager",
    self = this,
    _prefix = "_icon",
    CACHE_VERSION = "2.6";

  this.add = function add(id, icon, iconsFormat) {
    if (!icon) {
      return false;
    }

    icon.format = iconsFormat;
    icon.id = id;

    if (!icon.format || !icon.revision || !icon.id) {
      return false;
    }

    self.get(id, function fromCache(iconFromCache) {
      if (!iconFromCache || iconFromCache.format < iconsFormat) {
        Evme.Storage.set(_prefix + id, icon);
        Evme.EventHandler.trigger(NAME, "iconAdded", icon);
      }
    });

    return true;
  };

  this.addIcons = function addIcons(icons, format) {
    for (var i = 0, icon; icon = icons[i++];) {
      this.add(icon.id, icon.icon, format);
    }
  };

  this.get = function get(id, callback) {
    Evme.Storage.get(_prefix + id, callback);
  };
};

Evme.IconGroup = new function Evme_IconGroup() {
  var ICON_HEIGHT,
    TEXT_HEIGHT,
    TEXT_MARGIN,
    WIDTH,
    HEIGHT;

  this.init = function init(options) {
    ICON_HEIGHT = 42 * Evme.Utils.devicePixelRatio,
    TEXT_HEIGHT = Evme.Utils.APPS_FONT_SIZE * 3,
    TEXT_MARGIN = 9 * Evme.Utils.devicePixelRatio,
    WIDTH = 72 * Evme.Utils.devicePixelRatio,
    HEIGHT = ICON_HEIGHT + TEXT_MARGIN + TEXT_HEIGHT;
  };

  this.get = function get(apps, query, callback) {
    var el = renderCanvas({
      "apps": apps || [],  // list of objects with "id" and "icon" properties
      "settings": Evme.Utils.getIconGroup() || [],  // the settings for the icons
      "query": query,
      "onReady": callback
    });

    return el;
  };

  function renderCanvas(options) {
    var apps = options.apps,
        settings = options.settings,
        query = options.query,
        onReady = options.onReady || function() {},
        elCanvas = document.createElement('canvas'),
        context = elCanvas.getContext('2d');

    elCanvas.width = WIDTH;
    elCanvas.height = query? HEIGHT : WIDTH;
    context.imagesToLoad = apps.length;
    context.imagesLoaded = [];

    if (!Array.isArray(apps)) {
      var objectApps = apps;
      apps = [];
      for (var id in objectApps) {
        apps.push({
          "icon": objectApps[id]
        });
      }
    }

    for (var i = 0; i < apps.length; i++) {
      // render the icons from bottom to top
      var app = apps[apps.length - 1 - i];

      if (typeof app !== "object") {
      	app = {
      	  "id": app,
      	};
      }

      if (app.icon) {
        loadIcon(app.icon, settings[(settings.length - apps.length) + i], context, i, onReady);
      } else if (app.id) {
        (function(app, icon, context, i, onReady) {
          Evme.IconManager.get(app.id, function onIconFromCache(appIcon) {
            loadIcon(Evme.Utils.formatImageData(appIcon), icon, context, i, onReady);
          });
        }(app, settings[i], context, i, onReady));
      }
    }
    
    // add the app name
    if (query) {
      Evme.Utils.writeTextToCanvas({
        "context": context,
        "text": query,
        "offset": ICON_HEIGHT + TEXT_MARGIN
      });
    }

    return elCanvas;
  }

  function loadIcon(iconSrc, settings, context, index, onReady) {
    if (!iconSrc) {
      onIconLoaded(context, null, settings, index, onReady);
      return false;
    }

    var image = new Image();

    image.onload = function onImageLoad() {
      var elImageCanvas = document.createElement('canvas'),
    	imageContext = elImageCanvas.getContext('2d'),
    	fixedImage = new Image(),
    	size = settings.size * Evme.Utils.devicePixelRatio;

      elImageCanvas.width = elImageCanvas.height = size;

      imageContext.beginPath();
      imageContext.arc(size / 2, size / 2, size / 2, 0, Math.PI * 2, false);
      imageContext.closePath();
      imageContext.clip();

      //first we draw the image resized and clipped (to be rounded)
      imageContext.drawImage(this, 0, 0, size, size);

      // dark overlay
      if (settings.darken) {
      	imageContext.fillStyle = 'rgba(0, 0, 0, ' + settings.darken + ')';
      	imageContext.beginPath();
      	imageContext.arc(size / 2, size / 2, Math.ceil(size / 2), 0, Math.PI * 2, false);
      	imageContext.fill();
      	imageContext.closePath();
      }

      fixedImage.onload = function onImageLoad() {
        onIconLoaded(context, this, settings, index, onReady);
      };

      fixedImage.src = elImageCanvas.toDataURL('image/png');
    };

    if (Evme.Utils.isBlob(iconSrc)) {
      Evme.Utils.blobToDataURI(iconSrc, function onDataReady(src) {
        image.src = src;
      });
    } else {
      image.src = Evme.Utils.formatImageData(iconSrc);
    }

    return true;
  }

  function onIconLoaded(context, image, settings, index, onAllIconsReady) {
    // once the image is ready to be drawn, we add it to an array
    // so when all the images are loaded we can draw them in the right order
    context.imagesLoaded.push({
      "image": image,
      "settings": settings,
      "index": index
    });

    if (context.imagesLoaded.length === context.imagesToLoad) {
      // all the images were loaded- let's sort correctly before drawing
      context.imagesLoaded.sort(function(a, b) {
        return a.index > b.index ? 1 : a.index < b.index ? -1 : 0;
      });

      // finally we're ready to draw the icons!
      for (var i = 0, obj; obj = context.imagesLoaded[i++];) {
      	var image = obj.image,
        	  settings = obj.settings,
        	  size = settings.size * Evme.Utils.devicePixelRatio;

      	if (!image) {
      	  continue;
      	}

      	// shadow
      	context.shadowOffsetX = settings.shadowOffset;
      	context.shadowOffsetY = settings.shadowOffset;
      	context.shadowBlur = settings.shadowBlur;
      	context.shadowColor = 'rgba(0, 0, 0, ' + settings.shadowOpacity + ')';

      	// rotation
      	context.save();
      	context.translate(settings.x * Evme.Utils.devicePixelRatio + size / 2, settings.y * Evme.Utils.devicePixelRatio + size / 2);
      	context.rotate((settings.rotate || 0) * Math.PI / 180);
      	// draw the icon already!
      	context.drawImage(image, -size / 2, -size / 2);
      	context.restore();
      }

      onAllIconsReady && onAllIconsReady(context.canvas);
    }
  }
};